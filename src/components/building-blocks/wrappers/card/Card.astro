---
import Component from "@components/utils/renderBlock.astro";
import Image from "@core-elements/image/Image.astro";

const {
  label,
  contentSections,
  beforeContentSections,
  afterContentSections,
  maxContentWidth,
  paddingHorizontal,
  paddingVertical,
  colorScheme,
  backgroundColor,
  backgroundImage,
  link,
  showBeforeAfter = true,
  rounded = false,
  border = false,
  class: className,
  editable = true,
  ...rest
} = Astro.props;

const {
  source = "",
  alt = "",
  positionVertical = "top",
  positionHorizontal = "center",
} = backgroundImage || {};

const htmlAttributes = Object.fromEntries(
  Object.entries(rest).filter(([key]) => key !== "_component")
);

const slugifyLabel = (label: string) => {
  return label
    .toLowerCase()
    .replace(/[^a-z0-9]+/g, "-")
    .replace(/^-+|-+$/g, "");
};

if (!htmlAttributes.id && label) {
  htmlAttributes.id = slugifyLabel(label);
}

const Tag = link ? "a" : "div";
---

<Tag
  {...htmlAttributes}
  {...link && { href: link }}
  class:list={["card", rounded && "rounded", border && "border", className]}
  data-theme={colorScheme}
>
  {
    source && (
      <Image
        class:list={["background-image"]}
        source={source}
        alt={alt}
        editable={editable}
        data-prop-src="backgroundImage.source"
        data-prop-alt="backgroundImage.alt"
        positionVertical={positionVertical}
        positionHorizontal={positionHorizontal}
        background={true}
      />
    )
  }
  {
    backgroundColor && (
      <div
        aria-hidden="true"
        class:list={["background", backgroundColor && `bg-${backgroundColor}`]}
      />
    )
  }

  {
    ((beforeContentSections && showBeforeAfter) || Astro.slots.has("before")) && (
      <div class="before-content">
        {beforeContentSections ? (
          <Component contentSections={beforeContentSections} propName="beforeContentSections" />
        ) : (
          <slot name="before" />
        )}
      </div>
    )
  }

  <div class="outer-content">
    <div
      class:list={[
        "content",
        paddingHorizontal && `pad-x-${paddingHorizontal}`,
        paddingVertical && `pad-y-${paddingVertical}`,
        maxContentWidth && `max-width-${maxContentWidth}`,
      ]}
    >
      {
        contentSections ? (
          <Component contentSections={contentSections} propName="contentSections" />
        ) : (
          <slot />
        )
      }
    </div>
  </div>

  {
    ((afterContentSections && showBeforeAfter) || Astro.slots.has("after")) && (
      <div class="after-content">
        {afterContentSections ? (
          <Component contentSections={afterContentSections} propName="afterContentSections" />
        ) : (
          <slot name="after" />
        )}
      </div>
    )
  }
</Tag>

<style lang="pcss">
  a.card:hover {
    transform: scale(1.05);
  }

  .card {
    color: inherit;
    display: block;
    margin-top: var(--spacing-lg);
    overflow: hidden;
    position: relative;
    text-decoration: none;
    transition:
      transform 0.2s ease,
      box-shadow 0.2s ease;

    &.rounded {
      border-radius: var(--radius-md);
    }

    &.border {
      border: 1px solid var(--color-border);
    }

    > .outer-content {
      height: 100%;
    }

    > .outer-content > .content {
      height: 100%;
      margin-inline: auto;
      position: relative;
      z-index: var(--layer-1);
      container-type: inline-size;

      > :global(editable-array) > :global(editable-array-item:first-child) > :global(*:first-child),
      > :global(:not(editable-array):first-child) {
        margin-top: 0 !important;
      }

      &.pad-x-xs {
        padding-inline: var(--spacing-xs);
      }

      &.pad-x-sm {
        padding-inline: var(--spacing-sm);
      }

      &.pad-x-md {
        padding-inline: var(--spacing-md);
      }

      &.pad-x-lg {
        padding-inline: var(--spacing-lg);
      }

      &.pad-x-xl {
        padding-inline: var(--spacing-xl);
      }

      &.pad-x-2xl {
        padding-inline: var(--spacing-2xl);
      }

      &.pad-x-3xl {
        padding-inline: var(--spacing-3xl);
      }

      &.pad-x-4xl {
        padding-inline: var(--spacing-4xl);
      }

      &.pad-x-5xl {
        padding-inline: var(--spacing-5xl);
      }

      &.pad-x-6xl {
        padding-inline: var(--spacing-6xl);
      }

      &.pad-y-xs {
        padding-block: var(--spacing-xs);
      }

      &.pad-y-sm {
        padding-block: var(--spacing-sm);
      }

      &.pad-y-md {
        padding-block: var(--spacing-md);
      }

      &.pad-y-lg {
        padding-block: var(--spacing-lg);
      }

      &.pad-y-xl {
        padding-block: var(--spacing-xl);
      }

      &.pad-y-2xl {
        padding-block: var(--spacing-2xl);
      }

      &.pad-y-3xl {
        padding-block: var(--spacing-3xl);
      }

      &.pad-y-4xl {
        padding-block: var(--spacing-4xl);
      }

      &.pad-y-5xl {
        padding-block: var(--spacing-5xl);
      }

      &.pad-y-6xl {
        padding-block: var(--spacing-6xl);
      }

      @media (--to-sm) {
        &.pad-y-xs {
          padding-block: var(--spacing-xs);
        }

        &.pad-y-sm {
          padding-block: var(--spacing-xs);
        }

        &.pad-y-md {
          padding-block: var(--spacing-sm);
        }

        &.pad-y-lg {
          padding-block: var(--spacing-md);
        }

        &.pad-y-xl {
          padding-block: var(--spacing-md);
        }

        &.pad-y-2xl {
          padding-block: var(--spacing-lg);
        }
      }

      &.max-width-xs {
        max-width: var(--content-width-xs);
      }

      &.max-width-sm {
        max-width: var(--content-width-sm);
      }

      &.max-width-md {
        max-width: var(--content-width-md);
      }

      &.max-width-lg {
        max-width: var(--content-width-lg);
      }

      &.max-width-xl {
        max-width: var(--content-width-xl);
      }

      &.max-width-2xl {
        max-width: var(--content-width-2xl);
      }

      &.max-width-3xl {
        max-width: var(--content-width-3xl);
      }
    }

    > .before-content,
    > .after-content {
      position: relative;
      z-index: var(--layer-2);

      > :global(editable-array) > :global(editable-array-item:first-child) > :global(*:first-child),
      > :global(:not(editable-array):first-child) {
        margin-top: 0 !important;
      }
    }

    > .outer-content {
      position: relative;
      z-index: var(--layer-2);
    }

    > .background {
      inset: 0;
      position: absolute;
    }

    > .background-image {
      z-index: var(--layer-1);
    }
    
    > .bg-base {
      background-color: var(--color-bg);
    }

    > .bg-surface {
      background-color: var(--color-bg-surface);
    }

    > .bg-accent {
      background-color: var(--color-bg-accent);
    }

    > .bg-highlight {
      background-color: var(--color-bg-highlight);
    }

    > .bg-wave {
      background-color: var(--color-bg-accent);
      background-image: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='1920' height='1098' aria-label='Blue layered gradient background' viewBox='0 0 4095 2341'><defs><linearGradient id='b' x1='0' x2='4095' y1='163' y2='1764' gradientUnits='userSpaceOnUse'><stop offset='0' stop-color='%23003ed8'/><stop offset='1' stop-color='%230045dc'/></linearGradient><linearGradient id='c' x1='-17.8' x2='2184.2' y1='1180' y2='1661' gradientUnits='userSpaceOnUse'><stop offset='0' stop-color='%230b6fed'/><stop offset='1' stop-color='%230737de'/></linearGradient><linearGradient id='d' x1='-.8' x2='2558.2' y1='1854.5' y2='2471' gradientUnits='userSpaceOnUse'><stop offset='0' stop-color='%230f7df5'/><stop offset='1' stop-color='%230e2fe2'/></linearGradient><linearGradient id='e' x1='2196.7' x2='4095.2' y1='0' y2='1177.5' gradientUnits='userSpaceOnUse'><stop offset='0' stop-color='%230263e5'/><stop offset='1' stop-color='%23014de1'/></linearGradient><linearGradient id='f' x1='2337.9' x2='4244.1' y1='234.1' y2='947.3' gradientUnits='userSpaceOnUse'><stop offset='0' stop-color='%230579ec'/><stop offset='1' stop-color='%230353e5'/></linearGradient><linearGradient id='g' x1='2839.4' x2='4296.5' y1='88.9' y2='634.1' gradientUnits='userSpaceOnUse'><stop offset='0' stop-color='%230d6eef'/><stop offset='1' stop-color='%230bb4fa'/></linearGradient><clipPath id='a'><path d='M0 0h4095v2341H0z'/></clipPath></defs><g clip-path='url(%23a)'><path fill='url(%23b)' d='M0 0h4095v2341H0z'/><path fill='url(%23c)' d='M988 1012C376 902-18 1121-18 1121v1220h4113v-488s-453 193-836 159c-447-39-649-159-1088-438-402-256-571-453-1183-562z' opacity='.9'/><path fill='url(%23d)' d='M-1 1612v724s3128 438 2468 0-1147-800-1692-809c-545-10-776 85-776 85z' opacity='.9'/><path fill='url(%23e)' d='M4095 0H1528s397 733 1109 1201 1458 423 1458 423z' opacity='.9'/><path fill='url(%23f)' d='M4244 0H2179s319 590 892 966 1173 340 1173 340z' opacity='.9'/><path fill='url(%23g)' d='M4296-90H2718s244 451 682 738 896 260 896 260z' opacity='.9'/></g></svg>");
      background-position-x: 50%;
      background-position-y: 50%;
      background-repeat: no-repeat;
      background-size: cover
    }
  }
</style>
